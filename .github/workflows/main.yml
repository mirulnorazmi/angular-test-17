name: CI/CD - Build and Deploy Angular App via Fleet

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: angular-test
  REGISTRY_URL: registry.smolelab.com
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build:
    runs-on: rke2-gh-runner

    steps:
      - name: üß© Checkout Repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: üì¶ Install & Build Angular
        run: |
          npm ci
          npm run build -- --configuration production

      - name: üîê Log in to Private Docker Registry
        run: echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY_URL }} -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

      - name: üèóÔ∏è Build Docker Image
        run: docker build -t ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .

      - name: üì§ Push Docker Image
        run: docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      # ===============================================================
      # CD: Trigger Fleet by updating deployment manifest in GitOps repo
      # ===============================================================

      - name: üì• Checkout Fleet Repo
        uses: actions/checkout@v4
        with:
          repository: smolelab/angular-test-17
          token: ${{ secrets.FLEET_GIT_PAT }}
          path: fleet-repo

      - name: üìù Update Deployment Image Tag
        run: |
          DEPLOYMENT_FILE="fleet-repo/deploy/deployment.yaml"
          echo "Updating image in $DEPLOYMENT_FILE..."
          sed -i "s|image: .*/${{ env.IMAGE_NAME }}:.*|image: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}|g" "$DEPLOYMENT_FILE"
          cd fleet-repo
          git diff

      - name: üöÄ Commit & Push Updated Manifests
        run: |
          cd fleet-repo
          git config user.name "Fleet CI Bot"
          git config user.email "ci-bot@users.noreply.github.com"
          git add deploy/deployment.yaml
          if git diff --cached --quiet; then
            echo "No changes detected ‚Äî skipping commit."
          else
            git commit -m "üöÄ Deploy ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
            git push
          fi
